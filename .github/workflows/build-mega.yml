name: Build US+Canada Mega-Rarities Map

on:
  schedule:
    - cron: "13 9 * * *"   # Daily 09:13 UTC
  workflow_dispatch:
    inputs:
      skip_commit:
        description: "Do not write to the repo (for testing only)."
        type: boolean
        default: false
      mode:
        description: "Map mode: 'aba5_only' (strict ABA Code 5) or 'union' (includes national scarcities)."
        type: choice
        options: [aba5_only, union]
        default: aba5_only
      back_days_recent:
        description: "Days of recent 'notable' records to fetch."
        type: string
        default: "1"
      per_species_max:
        description: "Max markers per species."
        type: string
        default: "1"

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  mega:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install pandas requests folium jq

      - name: Ensure data inputs exist
        run: |
          set -euxo pipefail
          test -f scripts/data/ABA_Checklist.csv
          test -f scripts/data/eBird_taxonomy_v2024.csv
          mkdir -p docs/mega

      - name: Verify ABA-5 list exists
        run: |
          set -euxo pipefail
          test -s docs/mega/aba5.json
          echo "ABA5 species count: $(jq 'length' docs/mega/aba5.json)"

      - name: Build mega map
        env:
          EBIRD_API_KEY: ${{ secrets.EBIRD_API_KEY }}
          MEGA_MODE: ${{ inputs.mode }}
          MEGA_BACK_DAYS_RECENT: ${{ inputs.back_days_recent }}
          MEGA_NATIONAL_MAX: "60"     # total markers cap
          MEGA_PER_SPECIES_MAX: "1"   # per-species cap
        run: |
          set -euxo pipefail
          python scripts/build_mega_map.py \
            --aba_csv scripts/data/ABA_Checklist.csv \
            --taxonomy_csv scripts/data/eBird_taxonomy_v2024.csv \
            --out_dir docs/mega \
            --codes 4,5
          echo "----- SUMMARY -----"
          jq '.' docs/mega/summary.json || true
          echo "-------------------"
          HTML_SIZE=$(stat -c%s docs/mega/index.html)
          echo "HTML size: $HTML_SIZE bytes"
          # fail if over 5 MB
          if [ "$HTML_SIZE" -gt 5000000 ]; then
            echo "‚ùå index.html exceeds 5 MB, likely unfiltered. Failing build."
            exit 1
          fi

      - name: Guard against malformed JS
        run: |
          set -euxo pipefail
          if grep -nE '^[[:space:]]*\.\{' docs/mega/index.html; then
            echo "Found '.{' in index.html - failing build"
            exit 1
          fi

      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: mega-diagnostics
          path: |
            docs/mega/aba5.json
            docs/mega/aba5_unresolved.json
            docs/mega/summary.json
            docs/mega/index.html
            docs/mega/*.csv
          if-no-files-found: warn

      - name: Commit and push docs/mega
        if: ${{ inputs.skip_commit != true }}
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/mega
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Build US+Canada mega-rarities map (${GITHUB_RUN_ID})"
            git pull --rebase || true
            git push
          fi
